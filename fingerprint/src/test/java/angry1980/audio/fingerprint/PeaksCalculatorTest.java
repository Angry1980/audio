package angry1980.audio.fingerprint;

import angry1980.audio.ClassPathAdapter;
import angry1980.audio.model.*;
import com.google.common.collect.ImmutableMap;
import org.junit.Before;
import org.junit.Test;

import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import static junit.framework.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertTrue;

public class PeaksCalculatorTest {

    private static Map<Long, long[]> hashes = ImmutableMap.of(
        //1L, new long[]{19210604240L, 19210604240L, 19212804240L, 20615004240L, 17014606440L, 18412807440L, 22412808440L, 19214010040L, 22816604240L, 22815606440L, 23415208240L, 19216406440L, 19210605640L, 23211606440L, 19212805840L, 19610608840L, 19615209640L, 17014806440L, 17815407640L, 18210804240L, 23414408440L, 23414806240L, 19214408440L, 18610608440L, 19215008640L, 17012006840L, 19412007840L, 19611606440L, 22616404240L, 20413610440L, 21213404240L, 18215009640L, 22010606440L, 21611808440L, 20411606440L, 23415410440L, 23413209440L, 21416607640L, 19213204640L, 18211608240L, 19412808440L, 21612409640L, 18813206640L, 20612004440L, 21815408640L, 23414210040L, 19812405240L, 18216006440L, 21213007640L, 22814805040L, 22613207040L, 22616805840L, 21610806840L, 17614004840L, 20410806240L, 22412810440L, 22415204240L, 21212408640L, 23414808440L, 21815604440L, 17016208040L, 20412010240L, 21212808440L, 19017006440L, 21212806240L, 19212608440L, 23411807640L, 17014810040L, 19411408640L, 19410605040L, 22411008240L, 17611805040L, 18414405240L, 19215009840L, 17812406440L, 21211406440L, 18612808640L, 22013607240L, 18416208840L, 21012408040L, 23212809840L, 17010604840L, 21610610040L, 17010609240L, 19014608440L, 23215404440L, 23013810040L, 17811410240L, 17016808240L, 18416609440L, 17411206240L, 21810604440L, 20015208440L, 23014209040L, 17015408440L, 19615409240L, 17816409040L, 19210607640L, 20011007240L, 19815009440L, 23417010440L, 21616005840L, 20015209640L, 21411008040L, 23414805040L, 23216206440L, 19216006040L, 23410604440L, 17015008440L, 22616406440L, 23416204240L, 17813010440L, 23216804240L, 22410606440L, 21011009240L, 18815206440L, 20816009240L, 17612807040L, 21214608440L, 19414207240L, 19812804240L, 23411608440L, 22414810440L, 17015808240L, 19815804440L, 17411008240L, 23013007040L, 19211608640L, 23416605840L, 20617004240L, 21216804040L, 17815805840L, 17014007840L, 21814804640L, 19812806440L, 18816007040L, 19412805840L, 22012807840L, 22413005240L, 19212405440L, 23215004440L, 21216806240L, 21213206640L, 19617008640L, 17210604840L, 22413406440L, 19815607440L, 18215007040L, 22616610240L, 23013809840L, 21415810440L, 22814606440L, 17814806040L, 23210806440L, 21217005240L, 17014204240L, 20213004440L, 17010605840L, 19610608640L, 23212808440L, 17815204840L, 19410604240L, 19414809040L, 19215008640L, 21213006440L, 23413809040L, 19815010240L, 23010604240L, 19210606440L, 23414205440L, 22411210240L, 19815604240L, 19212804240L, 18210605840L, 21212806840L, 21216606640L, 22414806040L, 18614005240L, 19213406440L, 19212604240L, 18814609640L, 20415205840L, 20812810440L, 22611007440L, 17615809640L, 23412805840L, 22415208440L, 20412804640L, 21212206840L, 23414407440L, 18411808640L, 22015010240L, 17814610040L, 19213604240L, 21211608440L, 23411010240L, 23013807640L, 22814805640L, 20614404240L, 17012805840L, 20815008040L, 20613807040L, 21811008240L, 21012808440L, 17612806440L, 18012804240L, 23414810040L, 21210609240L, 19615609440L, 21410804440L, 17613805640L, 23415808240L, 20612805640L, 19416604040L, 22414208440L, 17210607040L, 19614206440L, 19613008640L, 17012805040L, 19211205840L, 17414809840L, 19814809640L, 19012610440L, 21212008440L, 23210607440L, 20011404840L, 21217005440L, 20610605240L, 17012805440L, 19013009440L, 22816206040L, 20816004440L, 22615808440L, 23410608240L, 17810604240L, 23013606840L, 21213206440L, 17211205040L, 20015808240L, 17012206040L, 23415006240L, 19415404640L, 17611006440L, 21810609440L, 18212810440L, 23011808040L, 19215205440L, 21214208440L, 21213010040L, 19013805440L, 21811205440L, 17014406440L, 19015208640L, 19815208840L, 22214405040L, 20810606440L, 17216004240L, 22810610040L, 17412809640L, 18014804840L, 19214010240L, 17012205240L, 23013806440L, 21212605440L, 19414005440L, 21815810040L, 19611607640L, 17216408640L, 17011009040L, 21214604240L, 17012805040L, 17214808440L, 21411608040L, 19614608440L, 19814404840L, 17816608440L, 17012808440L, 19210605640L, 23416809240L, 18016005840L, 22413008240L, 17215404640L, 21215607840L, 23016406440L, 20814608840L, 18813408640L, 19414808240L, 19216806640L, 22012409640L, 20811808040L, 18016808640L, 18014810440L, 19212806440L, 20614807440L, 21812808440L, 18611208440L, 18610608240L, 20214806240L, 18015206640L, 19814608640L, 21611406040L, 20614807040L, 17416606040L, 20815804840L, 18011804440L, 17014806640L, 17812810040L, 17014808640L, 17013408440L, 23215409240L, 19210610240L, 20016806240L, 19414807640L, 19016805240L, 21412808840L, 19215610040L, 18012409640L, 22410606440L, 19211206440L, 23410608440L, 23010609840L, 18616406440L, 17813804040L, 19213804840L, 20410604240L, 19215006440L, 17011404240L, 22614806440L, 17412408440L, 19210606440L, 21615008240L, 23412204640L, 20013005440L, 23414804440L, 23410604240L, 19212804240L, 19212804240L, 19210604240L, 19212804240L}
        1L, new long[]{17017008640L, 17012808640L, 21417008640L, 17012808640L, 17212808240L, 20614809640L, 23411207240L, 20212809840L, 18411608640L, 22412808240L, 17416607240L, 19212806840L, 18411204240L, 23213205240L, 19011804240L, 21215807040L, 19214806040L, 21216606040L, 17815405640L, 21611008640L, 17016804840L, 22412405640L, 23217009840L, 17013009440L, 17214005640L, 18013604040L, 23014408040L, 23212808840L, 20212608640L, 21014806040L, 21011208640L, 20415004240L, 21212805640L, 17013808640L, 23412804240L, 21611004240L, 19014209840L, 19816608440L, 17212009440L, 23416406040L, 21617004040L, 19216609640L, 21813206440L, 23014009040L, 17415006840L, 20012807840L, 23015410440L, 17812809640L, 19615208440L, 17816210040L, 20410806440L, 17011608840L, 21813607040L, 19815407240L, 21812609040L, 21010610240L, 21212808640L, 17411004240L, 23416008040L, 19013009040L, 21216010240L, 20415608240L, 17015409040L, 19012810240L, 19815804840L, 18817005440L, 17011208440L, 20217004640L, 22814004640L, 21413410240L, 22216409240L, 21616405240L, 18813410440L, 19016804040L, 21412807440L, 18412806440L, 17210804240L, 19014409240L, 17814610240L, 17416207840L, 23415407440L, 21415609640L, 20012810240L, 18615809440L, 17016006440L, 17813007840L, 20013804240L, 23011604240L, 23216605240L, 18811607840L, 23412609840L, 20414005040L, 17010606640L, 20814804840L, 22217010240L, 18612606840L, 18014804040L, 21415207440L, 22214604840L, 21412606840L, 20816805640L, 22615008040L, 19412608840L, 22016010440L, 22414205640L, 21612806240L, 21412604440L, 21214204240L, 21015010440L, 22612804240L, 23412408640L, 21010604240L, 21215607040L, 21413008640L, 18616208840L, 17212808640L, 18617007840L, 23212809640L, 17017004640L, 19013004440L, 23212208640L, 21016807240L, 22411608640L, 20016404640L, 18613208840L, 22012810040L, 20214007040L, 23415404840L, 18211809440L, 19413408640L, 21010604840L, 19011810240L, 22815804640L, 17413409240L, 22212805440L, 23014208840L, 21611805440L, 18414205440L, 20210604840L, 18410804240L, 22213609840L, 18012608840L, 23013205840L, 17415205040L, 21411609640L, 22012809040L, 22215010240L, 18814009840L, 21215406040L, 19612205040L, 21010807240L, 18812804240L, 21612204240L, 21617004440L, 23010607040L, 23016405240L, 19812804440L, 21411608040L, 21410605040L, 17012808640L, 21415209840L, 21212808640L, 21415008640L, 17214209640L, 22812809040L, 18014008440L, 20415008440L, 17214808640L, 21412804240L, 21616010040L, 22415205240L, 20212607640L, 17816208640L, 21416009840L, 21613808640L, 21413205640L, 21812206240L, 22411408640L, 18814607640L, 21016608640L, 22213604240L, 21811604440L, 20814207040L, 22214808840L, 19412807240L, 23213204240L, 17413006840L, 18413404240L, 17617004240L, 18815005840L, 19810808240L, 20616806840L, 20212607640L, 20016808440L, 23417010040L, 20415207240L, 20215406440L, 23011410440L, 21410608440L, 23211606040L, 22016204840L, 21614008440L, 22216604640L, 21417004040L, 19612809040L, 22814808440L, 20212804240L, 18412804240L, 19013405440L, 21812208840L, 17215807640L, 17416609840L, 17011407640L, 17213808240L, 23017006840L, 21214206640L, 22812807040L, 17214407640L, 21214810040L, 22615208640L, 19612804840L, 17212007840L, 21015606840L, 19212809840L, 21215004440L, 23013005240L, 22611008040L, 22612407640L, 18410804440L, 17815805240L, 18012205040L, 19813208840L, 17417004440L, 20613208840L, 21411806240L, 19813607040L, 20212806640L, 20212810040L, 22816609840L, 23410806440L, 21412604640L, 21616809440L, 22012804440L, 18816807040L, 20813404240L, 21216005840L, 21411004640L, 23017006840L, 20211408640L, 17210804840L, 22411006440L, 23013605440L, 17212606240L, 17615006640L, 19811810240L, 17012808240L, 21012208640L, 21413607640L, 19416809240L, 21416809640L, 20610606840L, 18810610440L, 22612804240L, 21611004640L, 20411006640L, 20213204840L, 23215410240L, 17011606440L, 22013804640L, 23416408640L, 21414210240L, 20613806640L, 23215005640L, 17016409840L, 23213209640L, 17013607440L, 17012406440L, 21211409040L, 18615006240L, 21211805440L, 21816404240L, 19410804240L, 22212805440L, 21212805440L, 17813409240L, 17416006040L, 17216405240L, 19813405840L, 22614404240L, 21416005440L, 17416608440L, 20015606440L, 19012808440L, 21214808640L, 17013806640L, 17214009240L, 21412807440L, 17812405640L, 20613208840L, 17411005440L, 22812207240L, 21212409240L, 20416405640L, 20011809640L, 18414809040L, 20813206440L, 19613606440L, 17215009440L, 20817004840L, 18412004240L, 21210605240L, 21413208840L, 19415205440L, 20013010440L, 21412805240L, 20015610440L, 19212804240L, 21412804640L, 20012805240L, 21417006040L, 21412808440L, 19212806640L, 19217005840L, 23416204440L, 20816404240L, 21212806640L, 21416008640L, 17012809840L, 18416804640L, 21412806040L, 20216404240L, 23012405640L, 19811004640L, 21816806640L, 17012808440L, 21417008640L, 17012804240L, 17012808640L, 21417008640L}
    );

    private Track track1;
    private PeaksCalculator calculator;

    @Before
    public void init(){
        calculator = new PeaksCalculator(new ClassPathAdapter());
        track1 = ImmutableTrack.builder().id(1).cluster(0).path("/test1.mp3").build();
    }

    @Test
    public void testTrack1(){
        List<TrackHash> hashes = getHashes(track1.getId());
        Optional<Fingerprint> f = calculator.calculate(track1);
        assertTrue(f.isPresent());
        List<TrackHash> result = f.get().getHashes();
        assertNotNull(result);
        assertTrue(result.size() == hashes.size());
        //System.out.println(Arrays.toString(result.stream().mapToLong(TrackHash::getHash).toArray()));
        IntStream.range(0, result.size()).forEach(i -> assertEquals(result.get(i), hashes.get(i)));
    }

    private List<TrackHash> getHashes(long trackId){
        AtomicInteger time = new AtomicInteger();
        return Arrays.stream(hashes.get(trackId))
                .mapToObj(hash -> ImmutableTrackHash.builder().trackId(trackId).time(time.getAndIncrement()).hash(hash).build())
                .collect(Collectors.toList());
    }
}
